name: simulator-deploy

on:
  workflow_dispatch:
  push:
    tags:
      - 'simulator-*'  

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      image: ${{ steps.build_push.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute image tag from pom version + short SHA
        id: meta
        env:
          ECR_REPO: 721010870513.dkr.ecr.eu-north-1.amazonaws.com/bidbridge-simulator
        run: |
          VERSION_BASE="$(mvn -q -pl bidbridge-simulator -DforceStdout help:evaluate -Dexpression=project.version)"
          SHORT_SHA="${GITHUB_SHA::7}"
          TAG="${VERSION_BASE}-${SHORT_SHA}"
          IMAGE="${ECR_REPO}:${TAG}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: Build and push simulator image
        id: build_push
        run: |
          docker build -t "${{ steps.meta.outputs.image }}" -f bidbridge-simulator/Dockerfile .
          docker push "${{ steps.meta.outputs.image }}"
          echo "image=${{ steps.meta.outputs.image }}" >> "$GITHUB_OUTPUT"

  deploy:
    runs-on: [self-hosted, linux, x64]
    needs: build
    permissions:
      contents: read
    steps:
      - name: Verify AWS identity from EC2 instance role
        run: aws sts get-caller-identity

      - name: Resolve digest and restart simulator service
        env:
          IMAGE_TAG: ${{ needs.build.outputs.image }}
        run: |
          DIGEST=$(aws ecr describe-images \
            --region eu-north-1 \
            --repository-name bidbridge-simulator \
            --image-ids imageTag="${IMAGE_TAG##*:}" \
            --query 'imageDetails[0].imageDigest' \
            --output text)

          FULL_IMAGE="721010870513.dkr.ecr.eu-north-1.amazonaws.com/bidbridge-simulator@${DIGEST}"

          sudo mkdir -p /opt/bidbridge-simulator/etc
          sudo tee /opt/bidbridge-simulator/etc/bidbridge-simulator.env >/dev/null <<EOF
          IMAGE=${FULL_IMAGE}
          REGION=eu-north-1
          CONTAINER_NAME=bidbridge-simulator
          PORT=8081
          DSPS_FILE=s3://bidbridge-simulator-config/simulator/dsps.yml
          EOF

          sudo systemctl daemon-reload
          sudo systemctl restart bidbridge-simulator

          for i in $(seq 1 30); do
            if curl -fsS http://127.0.0.1:8081/actuator/health >/dev/null; then
              echo "Simulator is healthy"
              exit 0
            fi
            sleep 2
          done

          echo "Health check failed after waiting"
          docker ps -a
          docker logs bidbridge-simulator --tail=200 || true
          sudo journalctl -u bidbridge-simulator -n 200 --no-pager || true
          exit 1